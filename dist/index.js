"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("prop-types"),r=require("react-addons-shallow-compare"),o=require("react-addons-update"),n=require("classnames"),s=require("react-virtuoso");!function(e,t){void 0===t&&(t={});var r=t.insertAt;if(e&&"undefined"!=typeof document){var o=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===r&&o.firstChild?o.insertBefore(n,o.firstChild):o.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}(".react-sortable-treeview{height:100%;position:relative}.react-sortable-treeview .rstw-list{list-style-type:none;margin:0;padding:0 0 0 40px}.react-sortable-treeview .rstw-virtualTree{scroll-behavior:smooth}.react-sortable-treeview>.rstw-list{padding:0}.rstw-node{width:fit-content}.rstw-node.is-dragging .rstw-list{pointer-events:none}.rstw-node.is-dragging .rstw-node .rstw-row:before{background:#87ceeb;border:1px dashed #4682b4;border-radius:5px;content:\" \";height:100%;margin-top:-10px;position:absolute;width:100%;z-index:10}.rstw-node.cannot-drop .rstw-node .rstw-row:before{background:#e45372;border:1px dashed #e45372}.rstw-node.dragging:after{background-color:#000;content:\" \";height:100%;margin-left:-25px;position:absolute;top:0;width:2px}.rstw-node-icon{background-color:#fff;border:2px solid;border-radius:50%;cursor:pointer;height:20px;margin-left:-36px;margin-top:18px;position:absolute;width:20px}.rstw-drag-layer{left:0;pointer-events:none;position:fixed;top:0;z-index:100}.rstw-drag-layer>.rstw-list{left:0;padding:0;position:absolute;top:0}.rstw-icon{background-color:transparent;background-position:50%;background-repeat:no-repeat;height:20px;position:absolute;width:20px}.rstw-icon:before{content:\"-\";display:inline-block;height:0;overflow:hidden;width:0}.icon-plus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='14' height='13' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.562 5.5H1.048a1 1 0 1 0 0 2h4.514v4.514a1 1 0 1 0 2 0V7.5h4.515a1 1 0 1 0 0-2H7.562V.986a1 1 0 1 0-2 0V5.5Z' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-minus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='13' height='3' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='20' y='29.5' width='13' height='2' rx='1' transform='translate(-20 -29)' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-handler{background-color:transparent;background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 12h18M3 6h18M3 18h18'/%3E%3C/svg%3E\");background-position:50%;background-repeat:no-repeat;height:25px;margin-right:10px;width:25px}.rstw-node.is-dragging,.rstw-node.is-dragging .rstw-node-icon{opacity:0}.rstw-placementArrow{bottom:0;margin-left:-60px;margin-top:25px;position:absolute;top:0;z-index:1000}.rstw-node{display:flex;height:60px;position:relative}.rstw-row{height:42px;margin:10px 10px 10px 0}.rstw-default-node{align-items:center;background:#d3d3d3;border:1px solid;display:flex;height:100%;padding:0 10px;position:relative}.rstw-lines{height:100%;position:relative;width:40px}.rstw-halfVerticalLine:after{height:50%}.rstw-fullVerticalLine:after,.rstw-halfVerticalLine:after{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-fullVerticalLine:after{height:100%}.rstw-fullHotizontalLine:before{background:#000;content:\"\";height:2px;margin-left:15px;margin-top:29px;position:absolute;width:25px}.rstw-depthLine{height:100%}.rstw-showdepthLine:before{height:100%}.rstw-parentLine:after,.rstw-showdepthLine:before{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-parentLine:after{bottom:0;height:8px}.rstw-node-handler{align-items:center;cursor:pointer;display:flex;justify-content:center;padding:0 5px}.rstw-drag-layer .parentLine:after,.rstw-drag-layer .rstw-node-icon{opacity:0}.rstw-node.is-dragging{cursor:move}.rstw-node.cannot-drop{cursor:not-allowed}");const a=(e,t)=>{const r=e.map((e=>({...e,isCollapsed:e.isCollapsed||!0,[t]:e[t]?a(e[t],t):[]})));return r.forEach(i(0,t)),r},i=(e,t)=>r=>{r.depth=e,(r[t]||[]).forEach(i(e+1,t))},l=(e,t)=>e?e.reduce(((e,r)=>[...e,{...r},...l(r[t],t)]),[]):[];function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},d.apply(this,arguments)}const h=({className:t})=>e.createElement("i",{className:n(t)});h.propTypes={className:t.string};const p=({handlerProps:t,showDragHandler:r,handler:o})=>r?o?e.createElement("div",t,o):e.createElement("span",d({className:"rstw-node-handler"},t),e.createElement(h,{className:n("icon-handler")})):null,c=({isCollapsed:t,hasChildren:r,node:o,onToggleCollapse:s,handlerProps:a,showDragHandler:i,renderNode:l,dragNode:c,isCopy:g,destinationPlacement:u,renderPlacementArrow:m,rowProps:w,handler:f})=>{const y=l({node:o,dragHandler:p({handlerProps:a,showDragHandler:i,handler:f})});return e.createElement("div",null,(({isCollapsed:t,hasChildren:r,node:o,onToggleCollapse:s})=>r?e.createElement("div",{className:"rstw-node-icon",onClick:()=>s(o)},e.createElement(h,{className:n("rstw-icon",{"icon-plus-gray":t,"icon-minus-gray":!t})})):null)({isCollapsed:t,hasChildren:r,node:o,onToggleCollapse:s}),c?.id===o?.id&&u&&!g&&m(),e.createElement("div",d({className:"rstw-row"},w),y??(({node:t,handlerProps:r,showDragHandler:o,handler:n})=>e.createElement("div",{className:"rstw-default-node"},p({handlerProps:r,showDragHandler:o,handler:n}),e.createElement("span",null,t.label)))({node:o,handlerProps:a,showDragHandler:i,handler:f})))},g=t=>{const{node:r,isCopy:o,options:s,isLastChild:a}=t,{dragNode:i,renderNode:l,showDragHandler:h,idProp:p,childrenProp:g,destinationPlacement:u,canDrop:m,draggable:w,showLines:f,handler:y}=s,{isCollapsed:v,depth:x}=r,D=!o&&i&&i[p]===r[p],P=r[g]&&r[g].length>0;let N={},b={};o||(w?i?N={...N,onMouseEnter:e=>s.onMouseEnter(e,r)}:b={...b,draggable:!0,onDragStart:e=>s.onDragStart(e,r)}:N={...N}),h&&w?b={...b}:N={...N,...b};const C="rstw-node"+(o?"-copy":""),E={className:n(C,C+"-"+r[p],{"is-dragging on-drag":D,"cannot-drop":!m,[C+"--last-child"]:a,[C+"--with--no-children"]:!P,[C+"--with-children"]:P,[C+"--children-open"]:P&&!v,[C+"--children-collapsed"]:P&&v})};return e.createElement("div",d({},E,{style:{opacity:o?.5:1,marginLeft:f||o?0:40*(x+1)+"px"}}),e.createElement("div",{className:"rstw-node"},(()=>{if(!o&&f){const t=s.getPathById(r[p]);return t.map(((r,o)=>{const n=s.getNodeByPath(t.slice(0,o));if(n){const{isNodeLastChild:t}=s.isNodeOfTypeLast(n);return e.createElement("div",{className:`rstw-depthLine ${t?void 0:"rstw-showdepthLine"}`,key:o,style:{width:"40px"}})}return null}))}return null})(),!o&&f?a?e.createElement("div",{className:"rstw-lines rstw-halfVerticalLine rstw-fullHotizontalLine"}):e.createElement("div",{className:"rstw-lines rstw-fullVerticalLine rstw-fullHotizontalLine"}):null,P&&!v&&f?e.createElement("div",{className:"rstw-parentLine"}):null,e.createElement(c,{node:r,handlerProps:b,showDragHandler:h,renderNode:l,isCollapsed:v,hasChildren:P,onToggleCollapse:s.onToggleCollapse,dragNode:i,isCopy:o,destinationPlacement:u,renderPlacementArrow:()=>{const{placementHeight:t}=u;return e.createElement("div",{className:"rstw-placementArrow"},e.createElement("div",{style:{width:"10px",height:t-35+"px",background:"#4682b4",position:"absolute"}}),e.createElement("div",{style:{width:"60px",height:"10px",background:"#4682b4",position:"absolute"}}),e.createElement("div",{style:{width:"20px",height:"10px",background:"#4682b4",position:"absolute",marginTop:t-35+"px"}}),e.createElement("div",{style:{width:0,height:0,borderTop:"15px solid transparent",borderLeft:"25px solid #4682b4",borderBottom:"15px solid transparent",position:"absolute",marginLeft:"20px",marginTop:t-45+"px"}}))},rowProps:N,handler:y})))};g.propTypes={node:t.object,isCopy:t.bool,options:t.object,index:t.number,isLastChild:t.bool};class u extends e.Component{constructor(e){super(e),this.state={treeData:[],oldTreeData:null,dragNode:null,destinationPlacement:null,isDirty:!1,canDrop:!0,onMoveData:null},this.el=null,this.elCopyStyles=null,this.mouse={last:{x:0},shift:{x:0}}}static propTypes={childrenProp:t.string,className:t.string,canDrop:t.func,group:t.oneOfType([t.number,t.string]),handler:t.node,showDragHandler:t.bool,idProp:t.string,treeData:t.array,onChange:t.func,renderNode:t.func,draggable:t.bool,showLines:t.bool,onMoveNode:t.func,onDragStateChanged:t.func,height:t.string};static defaultProps={childrenProp:"children",canDrop:()=>!0,group:Math.random().toString(36).slice(2),idProp:"id",treeData:[],onChange:()=>{},onMoveNode:()=>{},onDragStateChanged:()=>{},renderNode:()=>null,draggable:!0,showDragHandler:!1,showLines:!0,height:"100%",handler:null};componentDidMount(){let{treeData:e,childrenProp:t}=this.props;e=a(e,t),this.setState({treeData:e})}componentDidUpdate(e){const{treeData:t,childrenProp:o}=this.props;if(r({props:e,state:{}},this.props,{})){this.stopTrackMouse();let e={};this.setState({treeData:a(t,o),dragNode:null,isDirty:!1,...e})}}componentWillUnmount(){this.stopTrackMouse()}startTrackMouse=()=>{document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onDragEnd),document.addEventListener("keydown",this.onKeyDown)};stopTrackMouse=()=>{document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onDragEnd),document.removeEventListener("keydown",this.onKeyDown),this.elCopyStyles=null};moveNode=({dragNode:e,pathFrom:t,pathTo:r},n,s=this.state.treeData)=>{const{childrenProp:a,canDrop:i,idProp:l}=this.props,d=this.getNodeDepth(e),h=this.getRealNextPath(t,r,d);if(0===h.length)return;const p=h.length>r.length?r:r.slice(0,-1),c=this.getNodeByPath(p),g=i({node:e,destinationParent:c}),u=t.every(((e,t)=>e===r[t]));if(g&&!u)if(this.state.canDrop||this.setState({canDrop:!0}),"preview"!==n){const r=this.getSplicePath(t,{numToRemove:1,childrenProp:a}),n=this.getSplicePath(h,{numToRemove:0,treeDataToInsert:[{...e,parent:c?.id||null}],childrenProp:a});s=o(s,r),s=o(s,n),this.setState({treeData:s,isDirty:!0,destinationPlacement:null,onMoveData:{treeData:s,node:e,nextParentNode:c,prevNodeIndex:[...t].pop(),nextNodeIndex:[...h].pop(),prevPath:t,nextPath:h}})}else{let o=t.slice(0,-1);const n=this.getNodeByPath(o)[a].at(-1),i=document.querySelector(".rstw-node-"+e[l]),d=document.querySelector(".rstw-node-"+n[l]),p=i.getBoundingClientRect(),g=d.getBoundingClientRect(),u=p.top+p.height,m=g.top+g.height-u;this.setState({destinationPlacement:{dragNode:e,pathFrom:t,pathTo:r,placementHeight:m+60},onMoveData:{treeData:s,node:e,nextParentNode:c,prevNodeIndex:[...t].pop(),nextNodeIndex:[...h].pop(),prevPath:t,nextPath:h}})}else this.setState({canDrop:!1})};tryIncreaseDepth=e=>{const{idProp:t,childrenProp:r}=this.props,o=this.getPathById(e[t]),n=o[o.length-1];if(n>0){const t=this.getNodeByPath(o.slice(0,-1).concat(n-1)),s=o.slice(0,-1).concat(n-1).concat(t[r].length);let a;this.isCollapsed(t)&&(a=this.onToggleCollapse(t,!0)),this.moveNode({dragNode:e,pathFrom:o,pathTo:s},null,a)}};tryDecreaseDepth=e=>{const{idProp:t,childrenProp:r,collapsed:o}=this.props,n=this.getPathById(e[t]),s=n[n.length-1];if(n.length>1){const t=s+1===this.getNodeByPath(n.slice(0,-1))[r].length;let o=n.slice(0,-1);o[o.length-1]+=1,this.moveNode({dragNode:e,pathFrom:n,pathTo:o},t?null:"preview")}};getDistanceFromNextSibling=e=>{const{idProp:t,group:r,childrenProp:o}=this.props,n=this.getPathById(e[t]),s=n[n.length-1],a=this.getNodeByPath(n.slice(0,-1).concat(s+1));if(a){const n=document.querySelector(".rstw-"+r+" .rstw-node-"+e[t]),s=document.querySelector(".rstw-"+r+" .rstw-node-"+a[t]);if(s)return s.getBoundingClientRect().top-n.getBoundingClientRect().top;return 60*(e[o].length+1)}return 0};dragApply=()=>{const{onChange:e,onMoveNode:t}=this.props,{treeData:r,isDirty:o,destinationPlacement:n,onMoveData:s}=this.state;s&&t({...s}),this.setState({oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null,onMoveData:null}),n&&this.moveNode({...n}),o&&e(r)};dragRevert=()=>{const{oldTreeData:e}=this.state;this.setState({treeData:e,oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null})};getPathById=(e,t=this.state.treeData)=>{const{idProp:r,childrenProp:o}=this.props;let n=[];return t.every(((t,s)=>{if(t[r]===e)n.push(s);else if(t[o]){const r=this.getPathById(e,t[o]);r.length&&(n=n.concat(s).concat(r))}return 0===n.length})),n};getNodeByPath=(e,t=this.state.treeData)=>{const{childrenProp:r}=this.props;let o=null;return e.forEach((e=>{const n=o?o[r]:t;o=n[e]})),o};getNodeDepth=e=>{const{childrenProp:t}=this.props;let r=1;if(e[t].length>0){const o=e[t].map(this.getNodeDepth);r+=Math.max(...o)}return r};getSplicePath=(e,t={})=>{const{childrenProp:r}=this.props,o={},n=t.numToRemove||0,s=t.treeDataToInsert||[];s.length&&s.forEach(i(e.length-1,r));const a=e.length-1;let l=o;return e.forEach(((e,r)=>{if(r===a)l.$splice=[[e,n,...s]];else{const r={};l[e]={[t.childrenProp]:r},l=r}})),o};getRealNextPath=(e,t)=>{const{childrenProp:r}=this.props,o=e.length-1,n=t.length-1;if(e.length<t.length){let r=!1;return t.map(((s,a)=>r?a===n?s+1:s:"number"!=typeof e[a]?s:t[a]>e[a]&&a===o?(r=!0,s-1):s))}if(e.length===t.length&&t[n]>e[n]){const e=this.getNodeByPath(t);if(e[r]&&e[r].length&&!this.isCollapsed(e))return t.slice(0,-1).concat(t[n]-1).concat(0)}return t};getNodeOptions=()=>{const{renderNode:e,showDragHandler:t,idProp:r,childrenProp:o,group:n,draggable:s,showLines:a,handler:i}=this.props,{dragNode:l,destinationPlacement:d,canDrop:h}=this.state;return{dragNode:l,idProp:r,childrenProp:o,renderNode:e,showDragHandler:t,destinationPlacement:d,group:n,canDrop:h,draggable:s,showLines:a,handler:i,onDragStart:this.onDragStart,onMouseEnter:this.onMouseEnter,isCollapsed:this.isCollapsed,onToggleCollapse:this.onToggleCollapse,getDistanceFromNextSibling:this.getDistanceFromNextSibling,getPathById:this.getPathById,getNodeByPath:this.getNodeByPath,isNodeOfTypeLast:this.isNodeLast}};isCollapsed=e=>e.isCollapsed;onDragScroll=e=>{const t=document.querySelector(".rstw-virtualTree"),{clientY:r}=e,{scrollTop:o,clientHeight:n}=t;r<=o&&o>0?t.scrollTop-=10:n-r<=10&&(t.scrollTop+=10)};onDragStart=(e,t)=>{const{onDragStateChanged:r}=this.props;e&&(e.preventDefault(),e.stopPropagation(),r({isDragging:!0,node:t})),this.el=((e,t)=>{for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentNode}return null})(e.target,".rstw-row"),this.startTrackMouse(),this.onMouseMove(e),this.setState({dragNode:t,oldTreeData:this.state.treeData})};onDragEnd=(e,t)=>{const{onDragStateChanged:r}=this.props,{dragNode:o}=this.state;e&&e.preventDefault(),r({isDragging:!1,node:o}),this.stopTrackMouse(),this.el=null,t?this.dragRevert():this.dragApply()};onMouseMove=e=>{const{group:t}=this.props,{dragNode:r}=this.state,{clientX:o,clientY:n}=e,s={transform:"translate("+o+"px, "+(n-30)+"px)"};const a=document.querySelector(".rstw-"+t+" .rstw-drag-layer > .rstw-list");if(this.onDragScroll(e),this.elCopyStyles){this.elCopyStyles={...this.elCopyStyles,...s};for(let e in s)s.hasOwnProperty(e)&&(a.style[e]=s[e]);const e=o-this.mouse.last.x;e>=0&&this.mouse.shift.x>=0||e<=0&&this.mouse.shift.x<=0?this.mouse.shift.x+=e:this.mouse.shift.x=0,this.mouse.last.x=o,Math.abs(this.mouse.shift.x)>30&&(this.mouse.shift.x>0?this.tryIncreaseDepth(r):this.tryDecreaseDepth(r),this.mouse.shift.x=0)}else this.elCopyStyles={...s}};onMouseEnter=(e,t)=>{e&&(e.preventDefault(),e.stopPropagation());const{idProp:r}=this.props,{dragNode:o}=this.state;if(o[r]===t[r])return;const n=this.getPathById(o[r]),s=this.getPathById(t[r]);this.moveNode({dragNode:o,pathFrom:n,pathTo:s})};onToggleCollapse=(e,t)=>{let{treeData:r}=this.state;const{childrenProp:n,idProp:s}=this.props,a=this.getPathById(e[s]);e.isCollapsed?e.isCollapsed=!1:function e(t,r){if(t[n])for(let r=0;r<t[n].length;r++)t.isCollapsed||(t.isCollapsed=!0),e(t[n][r])}(e);let i={...e};const l=this.getSplicePath(a,{numToRemove:1,treeDataToInsert:[i],childrenProp:n});if(r=o(r,l),t)return r;this.setState({treeData:r})};onKeyDown=e=>{27===e.which&&this.onDragEnd(null,!0)};renderDragLayer=()=>{const{group:t,idProp:r}=this.props,{dragNode:o}=this.state,n=document.querySelector(".rstw-"+t+" .rstw-node-"+o[r]);let s={};n&&(s.width=n.clientWidth),this.elCopyStyles&&(s={...s,...this.elCopyStyles});const a=this.getNodeOptions();return e.createElement("div",{className:"rstw-drag-layer"},e.createElement("div",{className:"rstw-list",style:s},e.createElement(g,{node:o,options:a,isCopy:!0})))};isNodeLast=e=>{if(e){const{idProp:t,childrenProp:r}=this.props,{treeData:o}=this.state,n=this.getPathById(e[t]);e.parent&&n.splice(-1);const s=this.getNodeByPath(n);let a;const i=s[r].findIndex((t=>t.id===e.id));if(-1===i){a=o.findIndex((t=>t.id===e.id))+1===o.length}else a=i+1===s[r].length;return{isNodeLastChild:a}}return{isNodeLastChild:!0}};render(){const{group:t,className:r,childrenProp:o,height:a}=this.props,{treeData:i,dragNode:d}=this.state,h=this.getNodeOptions(),p=((e,t)=>{const r=[];return e.map((o=>{e.find((e=>e[t].some((e=>e.id===o.id))))?.isCollapsed||r.push(o)})),r})(l(i,o),o);return e.createElement("div",{className:n(r,"react-sortable-treeview","rstw-"+t,{"is-drag-active":d},"rstw-list rstw-group")},e.createElement(s.Virtuoso,{style:{height:a},className:"rstw-virtualTree",data:p,itemContent:(t,r)=>{const{isNodeLastChild:o}=this.isNodeLast(r);return e.createElement(g,{key:t,node:r,options:h,isLastChild:o})}}),d&&this.renderDragLayer())}}exports.default=u,exports.getFlatDataFromTree=l,exports.getTreeFromFlatData=({flatData:e,getKey:t=(e=>e.id),getParentKey:r=(e=>e.parentId),rootKey:o="0",childrenProp:n="children"})=>{if(!e)return[];const s={};if(e.forEach((e=>{const t=r(e);t in s?s[t].push(e):s[t]=[e]})),!(o in s))return[];const a=e=>{const r=t(e);return r in s?{...e,[n]:s[r].map((e=>a(e)))}:{...e}};return s[o].map((e=>a(e)))};
