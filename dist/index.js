"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("prop-types"),o=require("react-addons-shallow-compare"),r=require("react-addons-update"),n=require("classnames"),s=require("react-virtuoso");!function(e,t){void 0===t&&(t={});var o=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===o&&r.firstChild?r.insertBefore(n,r.firstChild):r.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}("#root,body,html{height:100%;margin:0}.react-sortable-treeview{height:100%;position:relative}.react-sortable-treeview .rstw-list{list-style-type:none;margin:0;padding:0 0 0 40px}.react-sortable-treeview>.rstw-list{padding:0}.rstw-node{width:fit-content}.rstw-node.is-dragging .rstw-list{pointer-events:none}.rstw-node.is-dragging .rstw-node .rstw-row:before{background:#87ceeb;border:1px dashed #4682b4;border-radius:5px;content:\" \";height:100%;margin-top:-10px;position:absolute;width:100%;z-index:10}.rstw-node.cannot-drop .rstw-node .rstw-row:before{background:#e45372;border:1px dashed #e45372}.rstw-node.dragging:after{background-color:#000;content:\" \";height:100%;margin-left:-25px;position:absolute;top:0;width:2px}.rstw-node-icon{background-color:#fff;border:2px solid;border-radius:50%;cursor:pointer;height:20px;margin-left:-36px;margin-top:18px;position:absolute;width:20px}.rstw-drag-layer{left:0;pointer-events:none;position:fixed;top:0;z-index:100}.rstw-drag-layer>.rstw-list{left:0;padding:0;position:absolute;top:0}.rstw-icon{background-color:transparent;background-position:50%;background-repeat:no-repeat;height:20px;position:absolute;width:20px}.rstw-icon:before{content:\"-\";display:inline-block;height:0;overflow:hidden;width:0}.icon-plus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='14' height='13' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.562 5.5H1.048a1 1 0 1 0 0 2h4.514v4.514a1 1 0 1 0 2 0V7.5h4.515a1 1 0 1 0 0-2H7.562V.986a1 1 0 1 0-2 0V5.5Z' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-minus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='13' height='3' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='20' y='29.5' width='13' height='2' rx='1' transform='translate(-20 -29)' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-handler{background-color:transparent;background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 12h18M3 6h18M3 18h18'/%3E%3C/svg%3E\");background-position:50%;background-repeat:no-repeat;height:25px;margin-right:10px;width:25px}.rstw-node.is-dragging,.rstw-node.is-dragging .rstw-node-icon{opacity:0}.rstw-placementArrow{bottom:0;margin-left:-60px;margin-top:25px;position:absolute;top:0;z-index:1000}.rstw-node{display:flex;height:60px;position:relative}.rstw-row{height:42px;margin:10px 10px 10px 0}.rstw-default-node{align-items:center;background:#d3d3d3;border:1px solid;display:flex;height:100%;padding:0 10px;position:relative}.rstw-lines{height:100%;position:relative;width:40px}.rstw-halfVerticalLine:after{height:50%}.rstw-fullVerticalLine:after,.rstw-halfVerticalLine:after{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-fullVerticalLine:after{height:100%}.rstw-fullHotizontalLine:before{background:#000;content:\"\";height:2px;margin-left:15px;margin-top:29px;position:absolute;width:25px}.rstw-depthLine{height:100%}.rstw-showdepthLine:before{height:100%}.rstw-parentLine:after,.rstw-showdepthLine:before{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-parentLine:after{bottom:0;height:8px}.rstw-node-handler{align-items:center;cursor:pointer;display:flex;justify-content:center;padding:0 5px}.rstw-drag-layer .parentLine:after,.rstw-drag-layer .rstw-node-icon{opacity:0}.rstw-node.is-dragging{cursor:move}.rstw-node.cannot-drop{cursor:not-allowed}");const a=(e,t)=>{const o=e.map((e=>({...e,isCollapsed:e.isCollapsed||!0,[t]:e[t]?a(e[t],t):[]})));return o.forEach(i(0,t)),o},i=(e,t)=>o=>{o.depth=e,(o[t]||[]).forEach(i(e+1,t))},l=(e,t)=>e?e.reduce(((e,o)=>[...e,{...o},...l(o[t],t)]),[]):[];function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},d.apply(this,arguments)}const h=({className:t})=>e.createElement("i",{className:n(t)});h.propTypes={className:t.string};const p=({handlerProps:t,showDragHandler:o,handler:r})=>o?r?e.createElement("div",t,r):e.createElement("span",d({className:"rstw-node-handler"},t),e.createElement(h,{className:n("icon-handler")})):null,c=({isCollapsed:t,hasChildren:o,node:r,onToggleCollapse:s,handlerProps:a,showDragHandler:i,renderNode:l,dragNode:c,isCopy:g,destinationPlacement:u,renderPlacementArrow:m,rowProps:w,handler:f})=>{const y=l({node:r,dragHandler:p({handlerProps:a,showDragHandler:i,handler:f})});return e.createElement("div",null,(({isCollapsed:t,hasChildren:o,node:r,onToggleCollapse:s})=>o?e.createElement("div",{className:"rstw-node-icon",onClick:()=>s(r)},e.createElement(h,{className:n("rstw-icon",{"icon-plus-gray":t,"icon-minus-gray":!t})})):null)({isCollapsed:t,hasChildren:o,node:r,onToggleCollapse:s}),c?.id===r?.id&&u&&!g&&m(),e.createElement("div",d({className:"rstw-row"},w),y??(({node:t,handlerProps:o,showDragHandler:r,handler:n})=>e.createElement("div",{className:"rstw-default-node"},p({handlerProps:o,showDragHandler:r,handler:n}),e.createElement("span",null,t.label)))({node:r,handlerProps:a,showDragHandler:i,handler:f})))},g=t=>{const{node:o,isCopy:r,options:s,isLastChild:a}=t,{dragNode:i,renderNode:l,showDragHandler:h,idProp:p,childrenProp:g,destinationPlacement:u,canDrop:m,draggable:w,showLines:f,handler:y}=s,{isCollapsed:x,depth:P}=o,v=!r&&i&&i[p]===o[p],D=o[g]&&o[g].length>0;let N={},b={};r||(w?i?N={...N,onMouseEnter:e=>s.onMouseEnter(e,o)}:b={...b,draggable:!0,onDragStart:e=>s.onDragStart(e,o)}:N={...N}),h&&w?b={...b}:N={...N,...b};const C="rstw-node"+(r?"-copy":""),E={className:n(C,C+"-"+o[p],{"is-dragging on-drag":v,"cannot-drop":!m,[C+"--last-child"]:a,[C+"--with--no-children"]:!D,[C+"--with-children"]:D,[C+"--children-open"]:D&&!x,[C+"--children-collapsed"]:D&&x})};return e.createElement("div",d({},E,{style:{opacity:r?.5:1,marginLeft:f||r?0:40*(P+1)+"px"}}),e.createElement("div",{className:"rstw-node"},(()=>{if(!r&&f){const t=s.getPathById(o[p]);return t.map(((o,r)=>{const n=s.getNodeByPath(t.slice(0,r));if(n){const{isNodeLastChild:t}=s.isNodeOfTypeLast(n);return e.createElement("div",{className:`rstw-depthLine ${t?void 0:"rstw-showdepthLine"}`,key:r,style:{width:"40px"}})}return null}))}return null})(),!r&&f?a?e.createElement("div",{className:"rstw-lines rstw-halfVerticalLine rstw-fullHotizontalLine"}):e.createElement("div",{className:"rstw-lines rstw-fullVerticalLine rstw-fullHotizontalLine"}):null,D&&!x&&f?e.createElement("div",{className:"rstw-parentLine"}):null,e.createElement(c,{node:o,handlerProps:b,showDragHandler:h,renderNode:l,isCollapsed:x,hasChildren:D,onToggleCollapse:s.onToggleCollapse,dragNode:i,isCopy:r,destinationPlacement:u,renderPlacementArrow:()=>{const{placementHeight:t}=u;return e.createElement("div",{className:"rstw-placementArrow"},e.createElement("div",{style:{width:"10px",height:t-35+"px",background:"#4682b4",position:"absolute"}}),e.createElement("div",{style:{width:"60px",height:"10px",background:"#4682b4",position:"absolute"}}),e.createElement("div",{style:{width:"20px",height:"10px",background:"#4682b4",position:"absolute",marginTop:t-35+"px"}}),e.createElement("div",{style:{width:0,height:0,borderTop:"15px solid transparent",borderLeft:"25px solid #4682b4",borderBottom:"15px solid transparent",position:"absolute",marginLeft:"20px",marginTop:t-45+"px"}}))},rowProps:N,handler:y})))};g.propTypes={node:t.object,isCopy:t.bool,options:t.object,index:t.number,isLastChild:t.bool};class u extends e.Component{constructor(e){super(e),this.state={treeData:[],oldTreeData:null,dragNode:null,destinationPlacement:null,isDirty:!1,canDrop:!0,onMoveData:null},this.el=null,this.elCopyStyles=null,this.mouse={last:{x:0},shift:{x:0}}}static propTypes={childrenProp:t.string,className:t.string,canDrop:t.func,group:t.oneOfType([t.number,t.string]),handler:t.node,showDragHandler:t.bool,idProp:t.string,treeData:t.array,onChange:t.func,renderNode:t.func,draggable:t.bool,showLines:t.bool,onMoveNode:t.func,onDragStateChanged:t.func,height:t.string};static defaultProps={childrenProp:"children",canDrop:()=>!0,group:Math.random().toString(36).slice(2),idProp:"id",treeData:[],onChange:()=>{},onMoveNode:()=>{},onDragStateChanged:()=>{},renderNode:()=>null,draggable:!0,showDragHandler:!1,showLines:!0,height:"100%",handler:null};componentDidMount(){let{treeData:e,childrenProp:t}=this.props;e=a(e,t),this.setState({treeData:e})}componentDidUpdate(e){const{treeData:t,childrenProp:r}=this.props;if(o({props:e,state:{}},this.props,{})){this.stopTrackMouse();let e={};this.setState({treeData:a(t,r),dragNode:null,isDirty:!1,...e})}}componentWillUnmount(){this.stopTrackMouse()}startTrackMouse=()=>{document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onDragEnd),document.addEventListener("keydown",this.onKeyDown)};stopTrackMouse=()=>{document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onDragEnd),document.removeEventListener("keydown",this.onKeyDown),this.elCopyStyles=null};moveNode=({dragNode:e,pathFrom:t,pathTo:o},n,s=this.state.treeData)=>{const{childrenProp:a,canDrop:i,idProp:l}=this.props,d=this.getNodeDepth(e),h=this.getRealNextPath(t,o,d);if(0===h.length)return;const p=h.length>o.length?o:o.slice(0,-1),c=this.getNodeByPath(p),g=i({node:e,destinationParent:c}),u=t.every(((e,t)=>e===o[t]));if(g&&!u)if(this.state.canDrop||this.setState({canDrop:!0}),"preview"!==n){const o=this.getSplicePath(t,{numToRemove:1,childrenProp:a}),n=this.getSplicePath(h,{numToRemove:0,treeDataToInsert:[{...e,parent:c?.id||null}],childrenProp:a});s=r(s,o),s=r(s,n),this.setState({treeData:s,isDirty:!0,destinationPlacement:null,onMoveData:{treeData:s,node:e,nextParentNode:c,prevNodeIndex:[...t].pop(),nextNodeIndex:[...h].pop(),prevPath:t,nextPath:h}})}else{let r=t.slice(0,-1);const n=this.getNodeByPath(r)[a].at(-1),i=document.querySelector(".rstw-node-"+e[l]),d=document.querySelector(".rstw-node-"+n[l]),p=i.getBoundingClientRect(),g=d.getBoundingClientRect(),u=p.top+p.height,m=g.top+g.height-u;this.setState({destinationPlacement:{dragNode:e,pathFrom:t,pathTo:o,placementHeight:m+60},onMoveData:{treeData:s,node:e,nextParentNode:c,prevNodeIndex:[...t].pop(),nextNodeIndex:[...h].pop(),prevPath:t,nextPath:h}})}else this.setState({canDrop:!1})};tryIncreaseDepth=e=>{const{idProp:t,childrenProp:o}=this.props,r=this.getPathById(e[t]),n=r[r.length-1];if(n>0){const t=this.getNodeByPath(r.slice(0,-1).concat(n-1)),s=r.slice(0,-1).concat(n-1).concat(t[o].length);let a;this.isCollapsed(t)&&(a=this.onToggleCollapse(t,!0)),this.moveNode({dragNode:e,pathFrom:r,pathTo:s},null,a)}};tryDecreaseDepth=e=>{const{idProp:t,childrenProp:o,collapsed:r}=this.props,n=this.getPathById(e[t]),s=n[n.length-1];if(n.length>1){const t=s+1===this.getNodeByPath(n.slice(0,-1))[o].length;let r=n.slice(0,-1);r[r.length-1]+=1,this.moveNode({dragNode:e,pathFrom:n,pathTo:r},t?null:"preview")}};getDistanceFromNextSibling=e=>{const{idProp:t,group:o,childrenProp:r}=this.props,n=this.getPathById(e[t]),s=n[n.length-1],a=this.getNodeByPath(n.slice(0,-1).concat(s+1));if(a){const n=document.querySelector(".rstw-"+o+" .rstw-node-"+e[t]),s=document.querySelector(".rstw-"+o+" .rstw-node-"+a[t]);if(s)return s.getBoundingClientRect().top-n.getBoundingClientRect().top;return 60*(e[r].length+1)}return 0};dragApply=()=>{const{onChange:e,onMoveNode:t}=this.props,{treeData:o,isDirty:r,destinationPlacement:n,onMoveData:s}=this.state;s&&t({...s}),this.setState({oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null,onMoveData:null}),n&&this.moveNode({...n}),r&&e(o)};dragRevert=()=>{const{oldTreeData:e}=this.state;this.setState({treeData:e,oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null})};getPathById=(e,t=this.state.treeData)=>{const{idProp:o,childrenProp:r}=this.props;let n=[];return t.every(((t,s)=>{if(t[o]===e)n.push(s);else if(t[r]){const o=this.getPathById(e,t[r]);o.length&&(n=n.concat(s).concat(o))}return 0===n.length})),n};getNodeByPath=(e,t=this.state.treeData)=>{const{childrenProp:o}=this.props;let r=null;return e.forEach((e=>{const n=r?r[o]:t;r=n[e]})),r};getNodeDepth=e=>{const{childrenProp:t}=this.props;let o=1;if(e[t].length>0){const r=e[t].map(this.getNodeDepth);o+=Math.max(...r)}return o};getSplicePath=(e,t={})=>{const{childrenProp:o}=this.props,r={},n=t.numToRemove||0,s=t.treeDataToInsert||[];s.length&&s.forEach(i(e.length-1,o));const a=e.length-1;let l=r;return e.forEach(((e,o)=>{if(o===a)l.$splice=[[e,n,...s]];else{const o={};l[e]={[t.childrenProp]:o},l=o}})),r};getRealNextPath=(e,t)=>{const{childrenProp:o}=this.props,r=e.length-1,n=t.length-1;if(e.length<t.length){let o=!1;return t.map(((s,a)=>o?a===n?s+1:s:"number"!=typeof e[a]?s:t[a]>e[a]&&a===r?(o=!0,s-1):s))}if(e.length===t.length&&t[n]>e[n]){const e=this.getNodeByPath(t);if(e[o]&&e[o].length&&!this.isCollapsed(e))return t.slice(0,-1).concat(t[n]-1).concat(0)}return t};getNodeOptions=()=>{const{renderNode:e,showDragHandler:t,idProp:o,childrenProp:r,group:n,draggable:s,showLines:a,handler:i}=this.props,{dragNode:l,destinationPlacement:d,canDrop:h}=this.state;return{dragNode:l,idProp:o,childrenProp:r,renderNode:e,showDragHandler:t,destinationPlacement:d,group:n,canDrop:h,draggable:s,showLines:a,handler:i,onDragStart:this.onDragStart,onMouseEnter:this.onMouseEnter,isCollapsed:this.isCollapsed,onToggleCollapse:this.onToggleCollapse,getDistanceFromNextSibling:this.getDistanceFromNextSibling,getPathById:this.getPathById,getNodeByPath:this.getNodeByPath,isNodeOfTypeLast:this.isNodeLast}};isCollapsed=e=>e.isCollapsed;onDragStart=(e,t)=>{const{onDragStateChanged:o}=this.props;e&&(e.preventDefault(),e.stopPropagation(),o({isDragging:!0,node:t})),this.el=((e,t)=>{for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentNode}return null})(e.target,".rstw-row"),this.startTrackMouse(),this.onMouseMove(e),this.setState({dragNode:t,oldTreeData:this.state.treeData})};onDragEnd=(e,t)=>{const{onDragStateChanged:o}=this.props,{dragNode:r}=this.state;e&&e.preventDefault(),o({isDragging:!1,node:r}),this.stopTrackMouse(),this.el=null,t?this.dragRevert():this.dragApply()};onMouseMove=e=>{const{group:t}=this.props,{dragNode:o}=this.state,{clientX:r,clientY:n}=e,s={transform:"translate("+r+"px, "+n+"px)"};const a=document.querySelector(".rstw-"+t+" .rstw-drag-layer > .rstw-list");if(this.elCopyStyles){this.elCopyStyles={...this.elCopyStyles,...s};for(let e in s)s.hasOwnProperty(e)&&(a.style[e]=s[e]);const e=r-this.mouse.last.x;e>=0&&this.mouse.shift.x>=0||e<=0&&this.mouse.shift.x<=0?this.mouse.shift.x+=e:this.mouse.shift.x=0,this.mouse.last.x=r,Math.abs(this.mouse.shift.x)>30&&(this.mouse.shift.x>0?this.tryIncreaseDepth(o):this.tryDecreaseDepth(o),this.mouse.shift.x=0)}else{const e=(i=this.el,l=i.getBoundingClientRect(),d=document.body,h=document.documentElement,p=window.pageYOffset||h.scrollTop||d.scrollTop,c=window.pageXOffset||h.scrollLeft||d.scrollLeft,g=h.clientTop||d.clientTop||0,u=h.clientLeft||d.clientLeft||0,m=l.top+p-g,w=l.left+c-u,{top:Math.round(m),left:Math.round(w)}),t=(e=>{let t=0,o=0;for(;e=e.parentNode;)t+=e.scrollTop||0,o+=e.scrollLeft||0;return{top:t,left:o}})(this.el);this.elCopyStyles={marginTop:e.top-n-t.top,marginLeft:e.left-r-t.left,...s}}var i,l,d,h,p,c,g,u,m,w};onMouseEnter=(e,t)=>{e&&(e.preventDefault(),e.stopPropagation());const{idProp:o}=this.props,{dragNode:r}=this.state;if(r[o]===t[o])return;const n=this.getPathById(r[o]),s=this.getPathById(t[o]);this.moveNode({dragNode:r,pathFrom:n,pathTo:s})};onToggleCollapse=(e,t)=>{let{treeData:o}=this.state;const{childrenProp:n,idProp:s}=this.props,a=this.getPathById(e[s]);e.isCollapsed?e.isCollapsed=!1:function e(t,o){if(t[n])for(let o=0;o<t[n].length;o++)t.isCollapsed||(t.isCollapsed=!0),e(t[n][o])}(e);let i={...e};const l=this.getSplicePath(a,{numToRemove:1,treeDataToInsert:[i],childrenProp:n});if(o=r(o,l),t)return o;this.setState({treeData:o})};onKeyDown=e=>{27===e.which&&this.onDragEnd(null,!0)};renderDragLayer=()=>{const{group:t,idProp:o}=this.props,{dragNode:r}=this.state,n=document.querySelector(".rstw-"+t+" .rstw-node-"+r[o]);let s={};n&&(s.width=n.clientWidth),this.elCopyStyles&&(s={...s,...this.elCopyStyles});const a=this.getNodeOptions();return e.createElement("div",{className:"rstw-drag-layer"},e.createElement("ol",{className:"rstw-list",style:s},e.createElement(g,{node:r,options:a,isCopy:!0})))};isNodeLast=e=>{if(e){const{idProp:t,childrenProp:o}=this.props,{treeData:r}=this.state,n=this.getPathById(e[t]);e.parent&&n.splice(-1);const s=this.getNodeByPath(n);let a;const i=s[o].findIndex((t=>t.id===e.id));if(-1===i){a=r.findIndex((t=>t.id===e.id))+1===r.length}else a=i+1===s[o].length;return{isNodeLastChild:a}}return{isNodeLastChild:!0}};render(){const{group:t,className:o,childrenProp:r,height:a}=this.props,{treeData:i,dragNode:d}=this.state,h=this.getNodeOptions(),p=((e,t)=>{const o=[];return e.map((r=>{e.find((e=>e[t].some((e=>e.id===r.id))))?.isCollapsed||o.push(r)})),o})(l(i,r),r);return e.createElement("div",{className:n(o,"react-sortable-treeview","rstw-"+t,{"is-drag-active":d},"rstw-list rstw-group")},e.createElement(s.Virtuoso,{style:{height:a},data:p,itemContent:(t,o)=>{const{isNodeLastChild:r}=this.isNodeLast(o);return e.createElement(g,{key:t,node:o,options:h,isLastChild:r})}}),d&&this.renderDragLayer())}}exports.default=u,exports.getTreeFromFlatData=({flatData:e,getKey:t=(e=>e.id),getParentKey:o=(e=>e.parentId),rootKey:r="0",childrenProp:n="children"})=>{if(!e)return[];const s={};if(e.forEach((e=>{const t=o(e);t in s?s[t].push(e):s[t]=[e]})),!(r in s))return[];const a=e=>{const o=t(e);return o in s?{...e,[n]:s[o].map((e=>a(e)))}:{...e}};return s[r].map((e=>a(e)))};
