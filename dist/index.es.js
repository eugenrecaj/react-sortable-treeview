import e,{createElement as t,Component as o}from"react";import r from"prop-types";import n from"react-addons-shallow-compare";import s from"react-addons-update";import a from"classnames";import{Virtuoso as i}from"react-virtuoso";!function(e,t){void 0===t&&(t={});var o=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===o&&r.firstChild?r.insertBefore(n,r.firstChild):r.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}("#root,body,html{height:100%;margin:0}.react-sortable-treeview{height:100%;position:relative}.react-sortable-treeview .rstw-list{list-style-type:none;margin:0;padding:0 0 0 40px}.react-sortable-treeview>.rstw-list{padding:0}.rstw-node{width:fit-content}.rstw-node.is-dragging .rstw-list{pointer-events:none}.rstw-node.is-dragging .rstw-node .rstw-row:before{background:#87ceeb;border:1px dashed #4682b4;border-radius:5px;content:\" \";height:100%;margin-top:-10px;position:absolute;width:100%;z-index:10}.rstw-node.cannot-drop .rstw-node .rstw-row:before{background:#e45372;border:1px dashed #e45372}.rstw-node.dragging:after{background-color:#000;content:\" \";height:100%;margin-left:-25px;position:absolute;top:0;width:2px}.rstw-node-icon{background-color:#fff;border:2px solid;border-radius:50%;cursor:pointer;height:20px;margin-left:-36px;margin-top:18px;position:absolute;width:20px}.rstw-drag-layer{left:0;pointer-events:none;position:fixed;top:0;z-index:100}.rstw-drag-layer>.rstw-list{left:0;padding:0;position:absolute;top:0}.rstw-icon{background-color:transparent;background-position:50%;background-repeat:no-repeat;height:20px;position:absolute;width:20px}.rstw-icon:before{content:\"-\";display:inline-block;height:0;overflow:hidden;width:0}.icon-plus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='14' height='13' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.562 5.5H1.048a1 1 0 1 0 0 2h4.514v4.514a1 1 0 1 0 2 0V7.5h4.515a1 1 0 1 0 0-2H7.562V.986a1 1 0 1 0-2 0V5.5Z' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-minus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='13' height='3' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='20' y='29.5' width='13' height='2' rx='1' transform='translate(-20 -29)' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-handler{background-color:transparent;background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 12h18M3 6h18M3 18h18'/%3E%3C/svg%3E\");background-position:50%;background-repeat:no-repeat;height:25px;margin-right:10px;width:25px}.rstw-node.is-dragging,.rstw-node.is-dragging .rstw-node-icon{opacity:0}.rstw-placementArrow{bottom:0;margin-left:-60px;margin-top:25px;position:absolute;top:0;z-index:1000}.rstw-node{display:flex;height:60px;position:relative}.rstw-row{height:42px;margin:10px 10px 10px 0}.rstw-default-node{align-items:center;background:#d3d3d3;border:1px solid;display:flex;height:100%;padding:0 10px;position:relative}.rstw-lines{height:100%;position:relative;width:40px}.rstw-halfVerticalLine:after{height:50%}.rstw-fullVerticalLine:after,.rstw-halfVerticalLine:after{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-fullVerticalLine:after{height:100%}.rstw-fullHotizontalLine:before{background:#000;content:\"\";height:2px;margin-left:15px;margin-top:29px;position:absolute;width:25px}.rstw-depthLine{height:100%}.rstw-showdepthLine:before{height:100%}.rstw-parentLine:after,.rstw-showdepthLine:before{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-parentLine:after{bottom:0;height:8px}.rstw-node-handler{align-items:center;cursor:pointer;display:flex;justify-content:center;padding:0 5px}.rstw-drag-layer .parentLine:after,.rstw-drag-layer .rstw-node-icon{opacity:0}.rstw-node.is-dragging{cursor:move}.rstw-node.cannot-drop{cursor:not-allowed}");const l=(e,t)=>{const o=e.map((e=>({...e,isCollapsed:e.isCollapsed||!0,[t]:e[t]?l(e[t],t):[]})));return o.forEach(d(0)),o},d=e=>t=>{t.depth=e,(t.children||[]).forEach(d(e+1))},h=(e,t)=>null==t?e:Array.isArray(t)?t.reduce(h,e):(e.push(t),h(e,t.children));function p(){return p=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},p.apply(this,arguments)}const c=({className:t})=>e.createElement("i",{className:a(t)});c.propTypes={className:r.string};const g=({handlerProps:t,showDragHandler:o,handler:r})=>o?r?e.createElement("div",t,r):e.createElement("span",p({className:"rstw-node-handler"},t),e.createElement(c,{className:a("icon-handler")})):null,u=({isCollapsed:t,hasChildren:o,node:r,onToggleCollapse:n,handlerProps:s,showDragHandler:i,renderNode:l,dragNode:d,isCopy:h,destinationPlacement:u,renderPlacementArrow:m,rowProps:w,handler:f})=>{const y=l({node:r,dragHandler:g({handlerProps:s,showDragHandler:i,handler:f})});return e.createElement("div",null,(({isCollapsed:t,hasChildren:o,node:r,onToggleCollapse:n})=>o?e.createElement("div",{className:"rstw-node-icon",onClick:()=>n(r)},e.createElement(c,{className:a("rstw-icon",{"icon-plus-gray":t,"icon-minus-gray":!t})})):null)({isCollapsed:t,hasChildren:o,node:r,onToggleCollapse:n}),d?.id===r?.id&&u&&!h&&m(),e.createElement("div",p({className:"rstw-row"},w),y??(({node:t,handlerProps:o,showDragHandler:r,handler:n})=>e.createElement("div",{className:"rstw-default-node"},g({handlerProps:o,showDragHandler:r,handler:n}),e.createElement("span",null,t.label)))({node:r,handlerProps:s,showDragHandler:i,handler:f})))},m=o=>{const{node:r,isCopy:n,options:s,isLastChild:i}=o,{dragNode:l,renderNode:d,showDragHandler:h,idProp:c,childrenProp:g,destinationPlacement:m,canDrop:w,draggable:f,showLines:y,handler:x}=s,{isCollapsed:D,depth:v}=r,P=!n&&l&&l[c]===r[c],N=r[g]&&r[g].length>0;let b={},C={};n||(f?l?b={...b,onMouseEnter:e=>s.onMouseEnter(e,r)}:C={...C,draggable:!0,onDragStart:e=>s.onDragStart(e,r)}:b={...b}),h&&f?C={...C}:b={...b,...C};const L="rstw-node"+(n?"-copy":""),E={className:a(L,L+"-"+r[c],{"is-dragging on-drag":P,"cannot-drop":!w,[L+"--last-child"]:i,[L+"--with--no-children"]:!N,[L+"--with-children"]:N,[L+"--children-open"]:N&&!D,[L+"--children-collapsed"]:N&&D})};return e.createElement("div",p({},E,{style:{opacity:n?.5:1,marginLeft:y||n?0:40*(v+1)+"px"}}),e.createElement("div",{className:"rstw-node"},(()=>{if(!n&&y){const e=s.getPathById(r[c]);return e.map(((o,r)=>{const n=s.getNodeByPath(e.slice(0,r));if(n){const{isNodeLastChild:e}=s.isNodeOfTypeLast(n);return t("div",{className:`rstw-depthLine ${e?void 0:"rstw-showdepthLine"}`,key:r,style:{width:"40px"}})}return null}))}return null})(),!n&&y?t("div",i?{className:"rstw-lines rstw-halfVerticalLine rstw-fullHotizontalLine"}:{className:"rstw-lines rstw-fullVerticalLine rstw-fullHotizontalLine"}):null,N&&!D&&y?t("div",{className:"rstw-parentLine"}):null,e.createElement(u,{node:r,handlerProps:C,showDragHandler:h,renderNode:d,isCollapsed:D,hasChildren:N,onToggleCollapse:s.onToggleCollapse,dragNode:l,isCopy:n,destinationPlacement:m,renderPlacementArrow:()=>{const{placementHeight:e}=m;return t("div",{className:"rstw-placementArrow"},t("div",{style:{width:"10px",height:e-35+"px",background:"#4682b4",position:"absolute"}}),t("div",{style:{width:"60px",height:"10px",background:"#4682b4",position:"absolute"}}),t("div",{style:{width:"20px",height:"10px",background:"#4682b4",position:"absolute",marginTop:e-35+"px"}}),t("div",{style:{width:0,height:0,borderTop:"15px solid transparent",borderLeft:"25px solid #4682b4",borderBottom:"15px solid transparent",position:"absolute",marginLeft:"20px",marginTop:e-45+"px"}}))},rowProps:b,handler:x})))};m.propTypes={node:r.object,isCopy:r.bool,options:r.object,index:r.number,isLastChild:r.bool};class w extends o{constructor(e){super(e),this.state={treeData:[],oldTreeData:null,dragNode:null,destinationPlacement:null,isDirty:!1,canDrop:!0,onMoveData:null},this.el=null,this.elCopyStyles=null,this.mouse={last:{x:0},shift:{x:0}}}static propTypes={childrenProp:r.string,className:r.string,canDrop:r.func,group:r.oneOfType([r.number,r.string]),handler:r.node,showDragHandler:r.bool,idProp:r.string,treeData:r.array,onChange:r.func,renderNode:r.func,draggable:r.bool,showLines:r.bool,onMoveNode:r.func,onDragStateChanged:r.func,height:r.string};static defaultProps={childrenProp:"children",canDrop:()=>!0,group:Math.random().toString(36).slice(2),idProp:"id",treeData:[],onChange:()=>{},onMoveNode:()=>{},onDragStateChanged:()=>{},renderNode:()=>null,draggable:!0,showDragHandler:!1,showLines:!0,height:"100%",handler:null};componentDidMount(){let{treeData:e,childrenProp:t}=this.props;e=l(e,t),this.setState({treeData:e})}componentDidUpdate(e){const{treeData:t,childrenProp:o}=this.props;if(n({props:e,state:{}},this.props,{})){this.stopTrackMouse();let e={};this.setState({treeData:l(t,o),dragNode:null,isDirty:!1,...e})}}componentWillUnmount(){this.stopTrackMouse()}startTrackMouse=()=>{document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onDragEnd),document.addEventListener("keydown",this.onKeyDown)};stopTrackMouse=()=>{document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onDragEnd),document.removeEventListener("keydown",this.onKeyDown),this.elCopyStyles=null};moveNode=({dragNode:e,pathFrom:t,pathTo:o},r,n=this.state.treeData)=>{const{childrenProp:a,canDrop:i,idProp:l}=this.props,d=this.getNodeDepth(e),h=this.getRealNextPath(t,o,d);if(0===h.length)return;const p=h.length>o.length?o:o.slice(0,-1),c=this.getNodeByPath(p),g=i({dragNode:e,destinationParent:c}),u=t.every(((e,t)=>e===o[t]));if(g&&!u)if(this.state.canDrop||this.setState({canDrop:!0}),"preview"!==r){const o=this.getSplicePath(t,{numToRemove:1,childrenProp:a}),r=this.getSplicePath(h,{numToRemove:0,treeDataToInsert:[{...e,parent:c?.id||null}],childrenProp:a});n=s(n,o),n=s(n,r),this.setState({treeData:n,isDirty:!0,destinationPlacement:null,onMoveData:{treeData:n,node:e,nextParentNode:c,prevNodeIndex:[...t].pop(),nextNodeIndex:[...h].pop(),prevPath:t,nextPath:h}})}else{let r=t.slice(0,-1);const s=this.getNodeByPath(r)[a].at(-1),i=document.querySelector(".rstw-node-"+e[l]),d=document.querySelector(".rstw-node-"+s[l]),p=i.getBoundingClientRect(),g=d.getBoundingClientRect(),u=p.top+p.height,m=g.top+g.height-u;this.setState({destinationPlacement:{dragNode:e,pathFrom:t,pathTo:o,placementHeight:m+60},onMoveData:{treeData:n,node:e,nextParentNode:c,prevNodeIndex:[...t].pop(),nextNodeIndex:[...h].pop(),prevPath:t,nextPath:h}})}else this.setState({canDrop:!1})};tryIncreaseDepth=e=>{const{idProp:t,childrenProp:o}=this.props,r=this.getPathById(e[t]),n=r[r.length-1];if(n>0){const t=this.getNodeByPath(r.slice(0,-1).concat(n-1)),s=r.slice(0,-1).concat(n-1).concat(t[o].length);let a;this.isCollapsed(t)&&(a=this.onToggleCollapse(t,!0)),this.moveNode({dragNode:e,pathFrom:r,pathTo:s},null,a)}};tryDecreaseDepth=e=>{const{idProp:t,childrenProp:o,collapsed:r}=this.props,n=this.getPathById(e[t]),s=n[n.length-1];if(n.length>1){const t=s+1===this.getNodeByPath(n.slice(0,-1))[o].length;let r=n.slice(0,-1);r[r.length-1]+=1,this.moveNode({dragNode:e,pathFrom:n,pathTo:r},t?null:"preview")}};getDistanceFromNextSibling=e=>{const{idProp:t,group:o,childrenProp:r}=this.props,n=this.getPathById(e[t]),s=n[n.length-1],a=this.getNodeByPath(n.slice(0,-1).concat(s+1));if(a){const n=document.querySelector(".rstw-"+o+" .rstw-node-"+e[t]),s=document.querySelector(".rstw-"+o+" .rstw-node-"+a[t]);if(s)return s.getBoundingClientRect().top-n.getBoundingClientRect().top;return 60*(e[r].length+1)}return 0};dragApply=()=>{const{onChange:e,onMoveNode:t}=this.props,{treeData:o,isDirty:r,destinationPlacement:n,onMoveData:s}=this.state;s&&t({...s}),this.setState({oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null,onMoveData:null}),n&&this.moveNode({...n}),r&&e(o)};dragRevert=()=>{const{oldTreeData:e}=this.state;this.setState({treeData:e,oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null})};getPathById=(e,t=this.state.treeData)=>{const{idProp:o,childrenProp:r}=this.props;let n=[];return t.every(((t,s)=>{if(t[o]===e)n.push(s);else if(t[r]){const o=this.getPathById(e,t[r]);o.length&&(n=n.concat(s).concat(o))}return 0===n.length})),n};getNodeByPath=(e,t=this.state.treeData)=>{const{childrenProp:o}=this.props;let r=null;return e.forEach((e=>{const n=r?r[o]:t;r=n[e]})),r};getNodeDepth=e=>{const{childrenProp:t}=this.props;let o=1;if(e[t].length>0){const r=e[t].map(this.getNodeDepth);o+=Math.max(...r)}return o};getSplicePath=(e,t={})=>{const o={},r=t.numToRemove||0,n=t.treeDataToInsert||[];n.length&&n.forEach(d(e.length-1));const s=e.length-1;let a=o;return e.forEach(((e,o)=>{if(o===s)a.$splice=[[e,r,...n]];else{const o={};a[e]={[t.childrenProp]:o},a=o}})),o};getRealNextPath=(e,t)=>{const{childrenProp:o}=this.props,r=e.length-1,n=t.length-1;if(e.length<t.length){let o=!1;return t.map(((s,a)=>o?a===n?s+1:s:"number"!=typeof e[a]?s:t[a]>e[a]&&a===r?(o=!0,s-1):s))}if(e.length===t.length&&t[n]>e[n]){const e=this.getNodeByPath(t);if(e[o]&&e[o].length&&!this.isCollapsed(e))return t.slice(0,-1).concat(t[n]-1).concat(0)}return t};getNodeOptions=()=>{const{renderNode:e,showDragHandler:t,idProp:o,childrenProp:r,group:n,draggable:s,showLines:a,handler:i}=this.props,{dragNode:l,destinationPlacement:d,canDrop:h}=this.state;return{dragNode:l,idProp:o,childrenProp:r,renderNode:e,showDragHandler:t,destinationPlacement:d,group:n,canDrop:h,draggable:s,showLines:a,handler:i,onDragStart:this.onDragStart,onMouseEnter:this.onMouseEnter,isCollapsed:this.isCollapsed,onToggleCollapse:this.onToggleCollapse,getDistanceFromNextSibling:this.getDistanceFromNextSibling,getPathById:this.getPathById,getNodeByPath:this.getNodeByPath,isNodeOfTypeLast:this.isNodeLast}};isCollapsed=e=>e.isCollapsed;onDragStart=(e,t)=>{const{onDragStateChanged:o}=this.props;e&&(e.preventDefault(),e.stopPropagation(),o({isDragging:!0,node:t})),this.el=((e,t)=>{for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentNode}return null})(e.target,".rstw-row"),this.startTrackMouse(),this.onMouseMove(e),this.setState({dragNode:t,oldTreeData:this.state.treeData})};onDragEnd=(e,t)=>{const{onDragStateChanged:o}=this.props,{dragNode:r}=this.state;e&&e.preventDefault(),o({isDragging:!1,node:r}),this.stopTrackMouse(),this.el=null,t?this.dragRevert():this.dragApply()};onMouseMove=e=>{const{group:t}=this.props,{dragNode:o}=this.state,{clientX:r,clientY:n}=e,s={transform:"translate("+r+"px, "+n+"px)"};const a=document.querySelector(".rstw-"+t+" .rstw-drag-layer > .rstw-list");if(this.elCopyStyles){this.elCopyStyles={...this.elCopyStyles,...s};for(let e in s)s.hasOwnProperty(e)&&(a.style[e]=s[e]);const e=r-this.mouse.last.x;e>=0&&this.mouse.shift.x>=0||e<=0&&this.mouse.shift.x<=0?this.mouse.shift.x+=e:this.mouse.shift.x=0,this.mouse.last.x=r,Math.abs(this.mouse.shift.x)>30&&(this.mouse.shift.x>0?this.tryIncreaseDepth(o):this.tryDecreaseDepth(o),this.mouse.shift.x=0)}else{const e=(i=this.el,l=i.getBoundingClientRect(),d=document.body,h=document.documentElement,p=window.pageYOffset||h.scrollTop||d.scrollTop,c=window.pageXOffset||h.scrollLeft||d.scrollLeft,g=h.clientTop||d.clientTop||0,u=h.clientLeft||d.clientLeft||0,m=l.top+p-g,w=l.left+c-u,{top:Math.round(m),left:Math.round(w)}),t=(e=>{let t=0,o=0;for(;e=e.parentNode;)t+=e.scrollTop||0,o+=e.scrollLeft||0;return{top:t,left:o}})(this.el);this.elCopyStyles={marginTop:e.top-n-t.top,marginLeft:e.left-r-t.left,...s}}var i,l,d,h,p,c,g,u,m,w};onMouseEnter=(e,t)=>{e&&(e.preventDefault(),e.stopPropagation());const{idProp:o}=this.props,{dragNode:r}=this.state;if(r[o]===t[o])return;const n=this.getPathById(r[o]),s=this.getPathById(t[o]);this.moveNode({dragNode:r,pathFrom:n,pathTo:s})};onToggleCollapse=(e,t)=>{let{treeData:o}=this.state;const{childrenProp:r,idProp:n}=this.props,a=this.getPathById(e[n]);e.isCollapsed?e.isCollapsed=!1:function e(t,o){if(t.children)for(let o=0;o<t.children.length;o++)t.isCollapsed||(t.isCollapsed=!0),e(t.children[o])}(e);let i={...e};const l=this.getSplicePath(a,{numToRemove:1,treeDataToInsert:[i],childrenProp:r});if(o=s(o,l),t)return o;this.setState({treeData:o})};onKeyDown=e=>{27===e.which&&this.onDragEnd(null,!0)};renderDragLayer=()=>{const{group:t,idProp:o}=this.props,{dragNode:r}=this.state,n=document.querySelector(".rstw-"+t+" .rstw-node-"+r[o]);let s={};n&&(s.width=n.clientWidth),this.elCopyStyles&&(s={...s,...this.elCopyStyles});const a=this.getNodeOptions();return e.createElement("div",{className:"rstw-drag-layer"},e.createElement("ol",{className:"rstw-list",style:s},e.createElement(m,{node:r,options:a,isCopy:!0})))};isNodeLast=e=>{if(e){const{idProp:t,childrenProp:o}=this.props,{treeData:r}=this.state,n=this.getPathById(e[t]);e.parent&&n.splice(-1);const s=this.getNodeByPath(n);let a;const i=s[o].findIndex((t=>t.id===e.id));if(-1===i){a=r.findIndex((t=>t.id===e.id))+1===r.length}else a=i+1===s[o].length;return{isNodeLastChild:a}}return{isNodeLastChild:!0}};render(){const{group:t,className:o,childrenProp:r,height:n}=this.props,{treeData:s,dragNode:l}=this.state,d=this.getNodeOptions(),p=((e,t)=>{const o=[];return e.map((r=>{e.find((e=>e[t].includes(r)))?.isCollapsed||o.push(r)})),o})(h([],s),r);return e.createElement("div",{className:a(o,"react-sortable-treeview","rstw-"+t,{"is-drag-active":l},"rstw-list rstw-group")},e.createElement(i,{style:{height:n},data:p,itemContent:(t,o)=>{const{isNodeLastChild:r}=this.isNodeLast(o);return e.createElement(m,{key:t,node:o,options:d,isLastChild:r})}}),l&&this.renderDragLayer())}}export{w as default};
