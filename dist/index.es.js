import e,{createElement as t,Component as r}from"react";import o from"prop-types";import n from"react-addons-shallow-compare";import s from"react-addons-update";import a from"classnames";import{Virtuoso as i}from"react-virtuoso";!function(e,t){void 0===t&&(t={});var r=t.insertAt;if(e&&"undefined"!=typeof document){var o=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===r&&o.firstChild?o.insertBefore(n,o.firstChild):o.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}(".react-sortable-treeview{height:100%;position:relative}.react-sortable-treeview .rstw-list{list-style-type:none;margin:0;padding:0 0 0 40px}.react-sortable-treeview .rstw-virtualTree{scroll-behavior:smooth}.react-sortable-treeview>.rstw-list{padding:0}.rstw-node{display:flex;height:60px;position:relative;width:max-content}.rstw-node.is-dragging .rstw-list{pointer-events:none}.rstw-node.is-dragging .rstw-node .rstw-row:before{background:#87ceeb;border:1px dashed #4682b4;border-radius:5px;content:\" \";height:100%;margin-top:-10px;position:absolute;width:100%;z-index:10}.rstw-node.cannot-drop .rstw-node .rstw-row:before{background:#e45372;border:1px dashed #e45372}.rstw-node.dragging:after{background-color:#000;content:\" \";height:100%;margin-left:-25px;position:absolute;top:0;width:2px}.rstw-node-icon{align-items:center;background-color:#fff;border:2px solid;border-radius:50%;cursor:pointer;display:flex;height:15px;justify-content:center;margin-left:-34px;margin-top:20px;position:absolute;width:15px}.rstw-node-icon:hover{scale:1.2}.rstw-drag-layer{left:0;pointer-events:none;position:fixed;top:0;z-index:100}.rstw-drag-layer>.rstw-list{left:0;padding:0;position:absolute;top:0}.rstw-icon{background-color:transparent;background-position:50%;background-repeat:no-repeat;height:10px;position:absolute;width:10px}.rstw-icon:before{content:\"-\";display:inline-block;height:0;overflow:hidden;width:0}.icon-plus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='14' height='13' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.562 5.5H1.048a1 1 0 1 0 0 2h4.514v4.514a1 1 0 1 0 2 0V7.5h4.515a1 1 0 1 0 0-2H7.562V.986a1 1 0 1 0-2 0V5.5Z' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-minus-gray{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='13' height='3' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='20' y='29.5' width='13' height='2' rx='1' transform='translate(-20 -29)' fill='%23979797' fill-rule='evenodd'/%3E%3C/svg%3E\")}.icon-handler{background-color:transparent;background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 12h18M3 6h18M3 18h18'/%3E%3C/svg%3E\");background-position:50%;background-repeat:no-repeat;height:25px;margin-right:10px;width:25px}.rstw-node.is-dragging,.rstw-node.is-dragging .rstw-node-icon{opacity:0}.rstw-placementArrow{bottom:0;margin-left:10px;margin-top:61px;position:absolute;top:0;z-index:1000}.rstw-row{height:42px;margin:10px 10px 10px 0}.rstw-default-node{align-items:center;background:#d3d3d3;border:1px solid;display:flex;height:100%;padding:0 10px;position:relative}.rstw-lines{height:100%;position:relative;width:40px}.rstw-halfVerticalLine:after{height:50%}.rstw-fullVerticalLine:after,.rstw-halfVerticalLine:after{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-fullVerticalLine:after{height:100%}.rstw-fullHotizontalLine:before{background:#000;content:\"\";height:2px;margin-left:15px;margin-top:29px;position:absolute;width:25px}.rstw-depthLine{height:100%}.rstw-showdepthLine:before{height:100%}.rstw-parentLine:after,.rstw-showdepthLine:before{background:#000;content:\"\";margin-left:15px;position:absolute;width:2px}.rstw-parentLine:after{bottom:0;height:8px}.rstw-node-handler{align-items:center;cursor:pointer;display:flex;justify-content:center;padding:0 5px}.rstw-drag-layer .parentLine:after,.rstw-drag-layer .rstw-node-icon{opacity:0}.rstw-node.is-dragging{cursor:move}.rstw-node.cannot-drop{cursor:not-allowed}");const l=(e,t,r,o)=>{const n=e.map((e=>(o?.includes(e[r])&&(e.isCollapsed=!1),{...e,isCollapsed:void 0===e.isCollapsed||e.isCollapsed,[t]:e[t]?l(e[t],t,r,o):[]})));return n.forEach(d(0,t)),n},d=(e,t)=>r=>{r.depth=e,(r[t]||[]).forEach(d(e+1,t))},h=(e,t="children")=>e?e.reduce(((e,r)=>[...e,{...r},...h(r[t],t)]),[]):[],p=({flatData:e,getKey:t=(e=>e.id),getParentKey:r=(e=>e.parentId),rootKey:o="0",childrenProp:n="children"})=>{if(!e)return[];const s={};if(e.forEach((e=>{const t=r(e);t in s?s[t].push(e):s[t]=[e]})),!(o in s))return[];const a=e=>{const r=t(e);return r in s?{...e,[n]:s[r].map((e=>a(e)))}:{...e}};return s[o].map((e=>a(e)))};function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},c.apply(this,arguments)}const g=({className:t})=>e.createElement("i",{className:a(t)});g.propTypes={className:o.string};const u=({handlerProps:t,showDragHandler:r,handler:o})=>r?o?e.createElement("div",t,o):e.createElement("span",c({className:"rstw-node-handler"},t),e.createElement(g,{className:a("icon-handler")})):null,m=({isCollapsed:t,hasChildren:r,node:o,onToggleCollapse:n,handlerProps:s,showDragHandler:i,renderNode:l,dragNode:d,isCopy:h,destinationPlacement:p,renderPlacementArrow:m,rowProps:w,handler:f})=>{const v=l({node:o,dragHandler:u({handlerProps:s,showDragHandler:i,handler:f})});return e.createElement("div",null,(({isCollapsed:t,hasChildren:r,node:o,onToggleCollapse:n})=>r?e.createElement("div",{className:"rstw-node-icon",onClick:()=>n(o)},e.createElement(g,{className:a("rstw-icon",{"icon-plus-gray":t,"icon-minus-gray":!t})})):null)({isCollapsed:t,hasChildren:r,node:o,onToggleCollapse:n}),d?.id===o?.id&&p&&!h&&m(),e.createElement("div",c({className:"rstw-row"},w),v??(({node:t,handlerProps:r,showDragHandler:o,handler:n})=>e.createElement("div",{className:"rstw-default-node"},u({handlerProps:r,showDragHandler:o,handler:n}),e.createElement("span",null,t.label)))({node:o,handlerProps:s,showDragHandler:i,handler:f})))},w=r=>{const{node:o,isCopy:n,options:s,isLastChild:i}=r,{dragNode:l,renderNode:d,showDragHandler:h,idProp:p,childrenProp:g,destinationPlacement:u,canDrop:w,draggable:f,showLines:v,handler:y,previewPath:P}=s,{isCollapsed:x,depth:D}=o,N=!n&&l&&l[p]===o[p],b=o[g]&&o[g].length>0||o.hasChildren,C=l?.[p]===o?.[p]&&P;let T={},E={};n||(f?l?T={...T,onMouseEnter:e=>s.onMouseEnter(e,o)}:E={...E,draggable:!0,onDragStart:e=>s.onDragStart(e,o)}:T={...T}),h&&f?E={...E}:T={...T,...E};const S="rstw-node"+(n?"-copy":""),L={className:a(S,S+"-"+o[p],`depth-${D}`,{"is-dragging on-drag":N,"cannot-drop":!w,[S+"--last-child"]:i,[S+"--with--no-children"]:!b,[S+"--with-children"]:b,[S+"--children-open"]:b&&!x,[S+"--children-collapsed"]:b&&x})};return e.createElement("div",c({},L,{"data-selector":D,style:{opacity:n?.5:1,marginLeft:v||n?0:40*(D+1)+"px"}}),e.createElement("div",{className:"rstw-node"},(()=>{if(!n&&v){let e=C||s.getPathById(o[p]);return e.map(((r,o)=>{const n=s.getNodeByPath(e.slice(0,o));if(n){const{isNodeLastChild:e}=s.isNodeOfTypeLast(n);return t("div",{className:`rstw-depthLine ${e?void 0:"rstw-showdepthLine"}`,key:o,style:{width:"40px"}})}return null}))}return null})(),n||!v||C?null:t("div",i?{className:"rstw-lines rstw-halfVerticalLine rstw-fullHotizontalLine"}:{className:"rstw-lines rstw-fullVerticalLine rstw-fullHotizontalLine"}),b&&!x&&v?t("div",{className:"rstw-parentLine"}):null,e.createElement(m,{node:o,handlerProps:E,showDragHandler:h,renderNode:d,isCollapsed:x,hasChildren:b,onToggleCollapse:s.onToggleCollapse,dragNode:l,isCopy:n,destinationPlacement:u,renderPlacementArrow:()=>{const{placementHeight:e}=u;return C?.length>D?null:t("div",{className:"rstw-placementArrow"},t("div",{style:{width:"10px",height:e-65+"px",background:"#4682b4",position:"absolute"}}),t("div",{style:{width:"20px",height:"10px",background:"#4682b4",position:"absolute",marginTop:e-65+"px"}}),t("div",{style:{width:0,height:0,borderTop:"15px solid transparent",borderLeft:"25px solid #4682b4",borderBottom:"15px solid transparent",position:"absolute",marginLeft:"20px",marginTop:e-75+"px"}}))},rowProps:T,handler:y})))};w.propTypes={node:o.object,isCopy:o.bool,options:o.object,index:o.number,isLastChild:o.bool};class f extends r{constructor(e){super(e),this.state={treeData:[],oldTreeData:null,dragNode:null,destinationPlacement:null,isDirty:!1,canDrop:!0,onMoveData:null,expandedNodes:[],previewPath:null,previewOriginalPath:null},this.el=null,this.elCopyStyles=null,this.mouse={last:{x:0},shift:{x:0}}}static propTypes={childrenProp:o.string,className:o.string,canDrop:o.func,group:o.oneOfType([o.number,o.string]),handler:o.node,showDragHandler:o.bool,idProp:o.string,treeData:o.array.isRequired,onChange:o.func,renderNode:o.func,draggable:o.bool,showLines:o.bool,onMoveNode:o.func,onVisibilityToggle:o.func,onDragStateChanged:o.func,height:o.string};static defaultProps={childrenProp:"children",canDrop:()=>!0,group:Math.random().toString(36).slice(2),idProp:"id",treeData:[],onChange:()=>{},onMoveNode:()=>{},onDragStateChanged:()=>{},renderNode:()=>null,draggable:!0,onVisibilityToggle:null,showDragHandler:!1,showLines:!0,height:"100%",handler:null};componentDidMount(){let{treeData:e,childrenProp:t,idProp:r}=this.props;e=l(e,t,r),this.setState({treeData:e})}componentDidUpdate(e){const{treeData:t,childrenProp:r,idProp:o}=this.props,{expandedNodes:s}=this.state;if(n({props:e,state:{}},this.props,{})){this.stopTrackMouse();let e={};this.setState({treeData:l(t,r,o,s),dragNode:null,isDirty:!1,...e})}}componentWillUnmount(){this.stopTrackMouse()}startTrackMouse=()=>{document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onDragEnd),document.addEventListener("keydown",this.onKeyDown)};stopTrackMouse=()=>{document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onDragEnd),document.removeEventListener("keydown",this.onKeyDown),this.elCopyStyles=null};moveNode=({dragNode:e,pathFrom:t,pathTo:r},o,n=this.state.treeData)=>{const{previewOriginalPath:a,previewPath:i}=this.state,{childrenProp:l,canDrop:d,idProp:h}=this.props,p=this.getNodeDepth(e),c=this.getRealNextPath(t,r,p);if(0===c.length)return;const g=c.length>r.length?r:r.slice(0,-1),u=this.getNodeByPath(g),m=d({node:e,destinationParent:u}),w=t.every(((e,t)=>e===r[t]));if(!m||w&&!i)return this.setState({canDrop:!1});if(this.state.canDrop||this.setState({canDrop:!0}),"preview"!==o){const r=this.getSplicePath(t,{numToRemove:1,childrenProp:l}),o=this.getSplicePath(c,{numToRemove:0,treeDataToInsert:[{...e,parent:u?.[h]||null}],childrenProp:l});return n=s(n,r),n=s(n,o),this.setState({treeData:n,isDirty:!0,destinationPlacement:null,previewPath:null,previewOriginalPath:null,onMoveData:{treeData:n,node:e,nextParentNode:u,prevNodeIndex:[...t].pop(),nextNodeIndex:[...c].pop(),prevPath:t,nextPath:c}}),{treeData:n}}{const o=document.querySelector(".rstw-node-"+e[h]),s=document.querySelector(".rstw-virtualTree > div > div").getBoundingClientRect();let i;const l=[...document.querySelectorAll(".rstw-node")],d=l.findIndex((t=>t.classList.contains("rstw-node-"+e[h]))),p=l.slice(l.length-(l.length-d),l.length).find((e=>Number(e.dataset.selector)<r?.length));if(p){const e=o.getBoundingClientRect(),t=p.getBoundingClientRect(),r=e.top+e.height;i=t.top+t.height-r}else{const e=o.getBoundingClientRect();i=s.height-e.bottom}this.setState({destinationPlacement:{dragNode:e,pathFrom:t,pathTo:r,placementHeight:i+60},previewPath:t.slice(0,-1),previewOriginalPath:a||t,onMoveData:{treeData:n,node:e,nextParentNode:u,prevNodeIndex:[...t].pop(),nextNodeIndex:[...c].pop(),prevPath:t,nextPath:c}})}};tryIncreaseDepth=e=>{const{idProp:t,childrenProp:r}=this.props,{previewPath:o,previewOriginalPath:n}=this.state,s=this.getPathById(e[t]),a=s[s.length-1],i=JSON.stringify(n)===JSON.stringify(o);if(a>0&&(i||!o)){const t=this.getNodeByPath(s.slice(0,-1).concat(a-1)),o=s.slice(0,-1).concat(a-1).concat(t[r].length);let n;this.isCollapsed(t)&&(n=this.onToggleCollapse(t,!0)),this.setState({previewPath:null,previewOriginalPath:null}),this.moveNode({dragNode:e,pathFrom:s,pathTo:o},null,n)}else if(n){const t=[...n].filter(((e,t)=>t<=o.length));this.moveNode({dragNode:e,pathFrom:o,pathTo:t},"preview"),this.setState({previewPath:t})}};tryDecreaseDepth=e=>{const{idProp:t,childrenProp:r}=this.props,{previewPath:o}=this.state,n=o||this.getPathById(e[t]),s=n[n.length-1];if(n.length>1){const t=s+1===this.getNodeByPath(n.slice(0,-1))[r].length;let a=n.slice(0,-1);a[a.length-1]+=1,this.moveNode({dragNode:e,pathFrom:n,pathTo:a},!t||o?"preview":null)}};dragApply=()=>{const{onMoveNode:e}=this.props,{treeData:t,destinationPlacement:r,onMoveData:o,previewOriginalPath:n}=this.state;if(o&&e({...o}),r){const{treeData:e}=this.moveNode({...r,pathFrom:n});this.onTreeDataChange(e)}else this.onTreeDataChange(t);this.setState({oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null,onMoveData:null,previewOriginalPath:null,previewPath:null})};dragRevert=()=>{const{oldTreeData:e}=this.state;this.setState({treeData:e,oldTreeData:null,dragNode:null,isDirty:!1,canDrop:!0,destinationPlacement:null})};onTreeDataChange=e=>{const{onChange:t}=this.props;t&&t(e)};getPathById=(e,t=this.state.treeData)=>{const{idProp:r,childrenProp:o}=this.props;let n=[];return t.every(((t,s)=>{if(t[r]===e)n.push(s);else if(t[o]){const r=this.getPathById(e,t[o]);r.length&&(n=n.concat(s).concat(r))}return 0===n.length})),n};getNodeByPath=(e,t=this.state.treeData)=>{const{childrenProp:r}=this.props;let o=null;return e.forEach((e=>{const n=o?o[r]:t;o=n[e]})),o};getNodeDepth=e=>{const{childrenProp:t}=this.props;let r=1;if(e[t].length>0){const o=e[t].map(this.getNodeDepth);r+=Math.max(...o)}return r};getSplicePath=(e,t={})=>{const{childrenProp:r}=this.props,o={},n=t.numToRemove||0,s=t.treeDataToInsert||[];s.length&&s.forEach(d(e.length-1,r));const a=e.length-1;let i=o;return e.forEach(((e,r)=>{if(r===a)i.$splice=[[e,n,...s]];else{const r={};i[e]={[t.childrenProp]:r},i=r}})),o};getRealNextPath=(e,t)=>{const{childrenProp:r}=this.props,o=e.length-1,n=t.length-1;if(e.length<t.length){let r=!1;return t.map(((s,a)=>r?a===n?s+1:s:"number"!=typeof e[a]?s:t[a]>e[a]&&a===o?(r=!0,s-1):s))}if(e.length===t.length&&t[n]>e[n]){const e=this.getNodeByPath(t);if(e[r]&&e[r].length&&!this.isCollapsed(e))return t.slice(0,-1).concat(t[n]-1).concat(0)}return t};getNodeOptions=()=>{const{renderNode:e,showDragHandler:t,idProp:r,childrenProp:o,group:n,draggable:s,showLines:a,handler:i}=this.props,{dragNode:l,destinationPlacement:d,canDrop:h,previewPath:p}=this.state;return{dragNode:l,idProp:r,childrenProp:o,renderNode:e,showDragHandler:t,destinationPlacement:d,group:n,canDrop:h,draggable:s,showLines:a,handler:i,previewPath:p,onDragStart:this.onDragStart,onMouseEnter:this.onMouseEnter,isCollapsed:this.isCollapsed,onToggleCollapse:this.onToggleCollapse,getPathById:this.getPathById,getNodeByPath:this.getNodeByPath,isNodeOfTypeLast:this.isNodeLast}};isCollapsed=e=>e.isCollapsed;onDragScroll=e=>{const t=document.querySelector(".rstw-virtualTree"),{clientY:r}=e,{scrollTop:o,clientHeight:n}=t;r<=o&&o>0?t.scrollTop-=10:n-r<=10&&(t.scrollTop+=10)};onDragStart=(e,t)=>{const{onDragStateChanged:r}=this.props;e&&(e.preventDefault(),e.stopPropagation(),r({isDragging:!0,node:t})),this.el=((e,t)=>{for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentNode}return null})(e.target,".rstw-row"),this.startTrackMouse(),this.onMouseMove(e),this.setState({dragNode:t,oldTreeData:this.state.treeData})};onDragEnd=(e,t)=>{const{onDragStateChanged:r}=this.props,{dragNode:o}=this.state;e&&e.preventDefault(),r({isDragging:!1,node:o}),this.stopTrackMouse(),this.el=null,t?this.dragRevert():this.dragApply()};onMouseMove=e=>{const{group:t}=this.props,{dragNode:r}=this.state,{clientX:o,clientY:n}=e,s={transform:"translate("+o+"px, "+(n-30)+"px)"};const a=document.querySelector(".rstw-"+t+" .rstw-drag-layer > .rstw-list");if(this.onDragScroll(e),this.elCopyStyles){this.elCopyStyles={...this.elCopyStyles,...s};for(let e in s)s.hasOwnProperty(e)&&(a.style[e]=s[e]);const e=o-this.mouse.last.x;e>=0&&this.mouse.shift.x>=0||e<=0&&this.mouse.shift.x<=0?this.mouse.shift.x+=e:this.mouse.shift.x=0,this.mouse.last.x=o,Math.abs(this.mouse.shift.x)>30&&(this.mouse.shift.x>0?this.tryIncreaseDepth(r):this.tryDecreaseDepth(r),this.mouse.shift.x=0)}else this.elCopyStyles={...s}};onMouseEnter=(e,t)=>{e&&(e.preventDefault(),e.stopPropagation());const{idProp:r}=this.props,{dragNode:o,previewPath:n,previewOriginalPath:s}=this.state;if(o[r]===t[r])return;const a=this.getPathById(o[r]),i=this.getPathById(t[r]);n&&s&&this.setState({previewPath:null,previewOriginalPath:null}),this.moveNode({dragNode:o,pathFrom:a,pathTo:i})};onToggleCollapse=(e,t)=>{let{treeData:r,expandedNodes:o}=this.state;const{childrenProp:n,idProp:a,onVisibilityToggle:i}=this.props,l=this.getPathById(e[a]);e.isCollapsed?e.isCollapsed=!1:e.isCollapsed=!0;let d={...e};if(d.isCollapsed){const e=o.findIndex((e=>e===d[a]));o.splice(e,1),this.setState({expandedNodes:o})}else this.setState({expandedNodes:[...o,d[a]]});const h=this.getSplicePath(l,{numToRemove:1,treeDataToInsert:[d],childrenProp:n});if(r=s(r,h),i&&i({treeData:r,node:d,isCollapsed:d.isCollapsed,path:l}),t)return r;this.setState({treeData:r})};onKeyDown=e=>{27===e.which&&this.onDragEnd(null,!0)};renderDragLayer=()=>{const{group:t,idProp:r}=this.props,{dragNode:o}=this.state,n=document.querySelector(".rstw-"+t+" .rstw-node-"+o[r]);let s={};n&&(s.width=n.clientWidth),this.elCopyStyles&&(s={...s,...this.elCopyStyles});const a=this.getNodeOptions();return e.createElement("div",{className:"rstw-drag-layer"},e.createElement("div",{className:"rstw-list",style:s},e.createElement(w,{node:o,options:a,isCopy:!0})))};isNodeLast=e=>{if(e){const{idProp:t,childrenProp:r}=this.props,{treeData:o}=this.state,n=this.getPathById(e[t]);e.parent&&n.splice(-1);const s=this.getNodeByPath(n);let a;if(s){const t=s[r].findIndex((t=>t.id===e.id));if(-1===t){a=o.findIndex((t=>t.id===e.id))+1===o.length}else a=t+1===s[r].length;return{isNodeLastChild:a}}}return{isNodeLastChild:!0}};render(){const{group:t,className:r,childrenProp:o,height:n}=this.props,{treeData:s,dragNode:l}=this.state,d=this.getNodeOptions(),p=((e,t)=>{const r=[];return e.map((o=>{e.find((e=>e[t].some((e=>e.id===o.id))))?.isCollapsed||r.push(o)})),r})(h(s,o),o);return e.createElement("div",{className:a(r,"react-sortable-treeview","rstw-"+t,{"is-drag-active":l},"rstw-list rstw-group")},e.createElement(i,{style:{height:n},className:"rstw-virtualTree",data:p,overscan:50,itemContent:(t,r)=>{const{isNodeLastChild:o}=this.isNodeLast(r);return e.createElement(w,{key:t,node:r,options:d,isLastChild:o})}}),l&&this.renderDragLayer())}}export{f as default,h as getFlatDataFromTree,p as getTreeFromFlatData};
